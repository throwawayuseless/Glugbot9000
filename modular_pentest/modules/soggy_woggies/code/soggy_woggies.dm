// Soggy woggies // (aka pissy shitties)

/obj/item/reagent_containers/food/snacks/popcorn/soggy_woggies
	name = "bag of soggy woggies"
	desc = "A traditional movie theater snack. It's a delicious slurry of popcorn and soda."
	icon = 'modular_pentest/modules/soggy_woggies/icons/soggy_woggies.dmi'
	icon_state = "soggy_woggies"
	trash = /obj/item/trash/popcorn/soggy_woggies
	list_reagents = list(
		/datum/reagent/consumable/nutriment = 2,
		/datum/reagent/consumable/sugar = 3,
		/datum/reagent/consumable/slurry_flavor = 1
	)
	filling_color = "#bd9e55"
	tastes = list("popcorn" = 2, "salt" = 1, "sugary syrup" = 1)

/obj/item/reagent_containers/food/snacks/popcorn/soggy_woggies/Initialize()
	. = ..()
	eatverb = pick("shlorp", "gobble", "gulp", "nibble")

// and friends //

/obj/item/trash/popcorn/soggy_woggies // Trash item
	name = "bag of soggy woggies"
	icon = 'modular_pentest/modules/soggy_woggies/icons/soggy_woggies.dmi'
	icon_state = "trash"

/datum/reagent/consumable/slurry_flavor // Dummy reagent purely for flavor
	name = "popcorn slurry flavor"
	description = "Buttery, syrupy popcorn flavor."
	taste_description = "sugary syrup with a hint of butter and salt"
	color = "#bd9e55"

// Allows popcorn to accept drink reagents // (yes this means you can poison popcorn)

/obj/item/reagent_containers/food/snacks/popcorn/Initialize()
	. = ..()
	if(!reagents)
		reagents = new(src)
	reagents.my_atom = src

/obj/item/reagent_containers/food/snacks/popcorn/attackby(obj/item/W, mob/user, params)
	if(istype(W, /obj/item/reagent_containers/food/drinks))
		var/obj/item/reagent_containers/food/drinks/drink = W

		if(drink.reagents && !(drink.reagents.flags & OPENCONTAINER))
			return TRUE

		if(drink.reagents && drink.reagents.total_volume)
			var/transferred = drink.reagents.trans_to(src, 10)
			if(transferred > 0)
				to_chat(user, "<span class='notice'>You pour [drink.name] into the [src.name].</span>")
			return TRUE
	. = ..()

// Recipe //

/obj/item/reagent_containers/food/snacks/popcorn/on_reagent_change()
	. = ..()

	if(!reagents || !reagents.total_volume)
		return

	var/list/valid_sodas = list(
		/datum/reagent/consumable/space_cola,
		/datum/reagent/consumable/spacemountainwind,
		/datum/reagent/consumable/sol_dry,
		/datum/reagent/consumable/dr_gibb,
		/datum/reagent/consumable/space_up,
		/datum/reagent/consumable/lemon_lime,
		/datum/reagent/consumable/pwr_game,
		/datum/reagent/consumable/nuka_cola,
		/datum/reagent/consumable/grey_bull,
		/datum/reagent/consumable/monkey_energy,
		/datum/reagent/consumable/shamblers,
		/datum/reagent/consumable/ethanol/thirteenloko,
		/datum/reagent/consumable/lean // you can make pissy shitties with lean because that's fucking funny
	)

	for(var/path in valid_sodas)
		if(!reagents)
			continue
		var/total = 0
		total += reagents.get_reagent_amount(path)

		if(total >= 20) // If there's 20u of any combination of valid sodas, you get delicious soggy popcorn
			slurrify()
			return

	if (reagents.get_reagent_amount(/datum/reagent/consumable/space_cola) >= 10 && reagents.get_reagent_amount(/datum/reagent/consumable/orangejuice) >= 10)
		slurrify()
		return // Special exception for Star-Kist

// SLURRIFICATION //

/obj/item/reagent_containers/food/snacks/popcorn/proc/slurrify()
	for(var/mob/M in viewers(src, null))
		to_chat(M, "<span class='notice'>The soda soaks into the popcorn with a satisfying sizzle.</span>")

	var/atom/container_loc = loc
	var/obj/item/reagent_containers/food/snacks/popcorn/soggy_woggies/result = new /obj/item/reagent_containers/food/snacks/popcorn/soggy_woggies(container_loc)

	// Adds the drink reagents to the slurry
	if (src.reagents)
		src.reagents.trans_to(result, src.reagents.total_volume)
	result.reagents.add_reagent(/datum/reagent/consumable/slurry_flavor, 1)

	qdel(src)

	if(ismob(container_loc))
		var/mob/holder = container_loc
		holder.put_in_hands(result)  // One slurry to rule them all
